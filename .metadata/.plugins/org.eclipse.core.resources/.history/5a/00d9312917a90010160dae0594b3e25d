package com.university.lms.service;

import com.university.lms.entity.Course;
import com.university.lms.entity.Enrollment;
import com.university.lms.entity.Evaluation;
import com.university.lms.entity.User;
import com.university.lms.repository.CourseRepository;
import com.university.lms.repository.EnrollmentRepository;
import com.university.lms.repository.EvaluationRepository;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

@Service
public class StudentService {
    private final EnrollmentRepository enrollmentRepository;
    private final EvaluationRepository evaluationRepository;
    private final CourseRepository courseRepository;

    public StudentService(EnrollmentRepository enrollmentRepository, EvaluationRepository evaluationRepository, CourseRepository courseRepository) {
        this.enrollmentRepository = enrollmentRepository;
        this.evaluationRepository = evaluationRepository;
        this.courseRepository = courseRepository;
    }

    public List<Course> getStudentCourses(Long userId) {
        return enrollmentRepository.findByUserId(userId)
                .stream()
                .map(enrollment -> courseRepository.findById(enrollment.getCourseId()).orElse(null))
                .filter(course -> course != null)
                .collect(Collectors.toList());
    }

    public List<StudyHistoryDTO> getStudentHistory(Long userId) {
        List<Enrollment> enrollments = enrollmentRepository.findByUserId(userId);
        return enrollments.stream()
                .map(enrollment -> {
                    Long courseId = enrollment.getCourseId();
                    Course course = courseRepository.findById(courseId).orElse(null);
                    if (course == null) {
                        return null;
                    }
                    List<Evaluation> evaluations = evaluationRepository.findByCourseId(courseId);
                    int examsTaken = evaluations.size();
                    Double passingGrade = null;
                    boolean passed = false;
                    for (Evaluation eval : evaluations) {
                        for (Map.Entry<User, Double> entry : eval.getStudentGrades().entrySet()) {
                            if (entry.getKey().getId().equals(userId)) {
                                Double grade = entry.getValue();
                                if (grade != null && grade >= 6.0) {
                                    passingGrade = grade;
                                    passed = true;
                                    break;
                                }
                            }
                        }
                        if (passed) break;
                    }
                    int ectsPoints = passed ? (course.getEctsPoints() > 0 ? course.getEctsPoints() : 6) : 0;
                    return new StudyHistoryDTO(
                            courseId,
                            course.getName(),
                            examsTaken,
                            passingGrade,
                            ectsPoints,
                            passed
                    );
                })
                .filter(dto -> dto != null)
                .collect(Collectors.toList());
    }
}